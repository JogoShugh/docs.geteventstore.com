{"conceptual":"\n<p sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"3\" sourceendlinenumber=\"3\">User defined projections are written in JavaScript (ECMASCRIPT 6).</p>\n<p sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"5\" sourceendlinenumber=\"5\">Example projection:</p>\n<!-- TODO: Which does what? Counts number myeventtype in account-1 stream, and the transformBy does somethingâ€¦ Map state to something else, setting it to 10 -->\n<pre sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"9\" sourceendlinenumber=\"32\"><code class=\"lang-JavaScript\">options({ //option\n    resultStreamName: &quot;my_demo_projection_result&quot;,\n    $includeLinks: false,\n    reorderEvents: false,\n    processingLag: 0\n})\n\nfromStream(&#39;account-1&#39;) //selector\n.when({ //filter\n    $init:function(){\n        return {\n            count: 0\n        }\n    },\n    myEventType: function(state, evnt){\n        s.count += 1;\n    }\n})\n.transformBy(function(state){ //transformation\n    state.count = 10;\n})\n.outputState() //transformation\n</code></pre><h2 id=\"projections-api\" sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"34\" sourceendlinenumber=\"34\">Projections API</h2>\n<h3 id=\"options\" sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"36\" sourceendlinenumber=\"36\">Options</h3>\n<table>\n    <thead>\n        <tr>\n            <th>Name</th>\n            <th>Description</th>\n            <th>Notes</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr>\n            <td><code>resultStreamName</code></td>\n            <td>Overrides the default resulting stream name for the outputState() transformation, which is $projections-{projection-name}-result.</td>\n            <td>\n            </td>\n        </tr>\n        <tr>\n            <td><code>$includeLinks</code></td>\n            <td>Configures the projection to include/exclude link to events.</td>\n            <td>\n                <b>Default: </b>false\n            </td>\n        </tr>\n         <tr>\n            <td><code>processingLag</code></td>\n            <td>When reorderEvents is turned on, this value is used to compare the total milliseconds between the first and last events in the buffer and if the value is equal or greater, the events in the buffer will be processed. The buffer is an ordered list of events.\n            </td>\n            <td>\n                <b>Default: </b>500ms\n                <p>\n                    Only valid for fromStreams() selector\n                </p>\n            </td>\n        </tr>\n        <tr>\n            <td><code>reorderEvents</code></td>\n            <td>Process events by storing a buffer of events ordered by their prepare position</td>\n            <td>\n                <b>Default: </b>false\n                <p>\n                    Only valid for fromStreams() selector\n                </p>\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n<h2 id=\"selectors\" sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"84\" sourceendlinenumber=\"84\">Selectors</h2>\n<table>\n    <thead>\n        <tr>\n            <th>Selector</th>\n            <th>Description</th>\n            <th>Notes</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr>\n            <td><code>fromAll()</code></td>\n            <td>Selects events from the $all stream.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>partitionBy</li>\n                    <li>when</li>\n                    <li>foreachStream</li>\n                    <li>outputState</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>fromCategory({category})</code></td>\n            <td>Selects events from the <code>$ce-{category}</code> stream.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>partitionBy</li>\n                    <li>when</li>\n                    <li>foreachStream</li>\n                    <li>outputState</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>fromStream({streamId})</code></td>\n            <td>Selects events from the {streamId} stream.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>partitionBy</li>\n                    <li>when</li>\n                    <li>outputState</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>fromStreams([]streams)</code></td>\n            <td>Selects events from the streams supplied.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>partitionBy</li>\n                    <li>when</li>\n                    <li>outputState</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>fromStreamsMatching(function filter)</code></td>\n            <td>Selects events from the $all stream that returns true for the given filter.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>when</li>\n                </ul>\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n<h2 id=\"filterstransformations\" sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"158\" sourceendlinenumber=\"158\">Filters/Transformations</h2>\n<table>\n    <thead>\n        <tr>\n            <th>Filter/Partition</th>\n            <th>Description</th>\n            <th>Notes</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr>\n            <td><code>when(handlers)</code></td>\n            <td>Allows only the given events of a particular to pass through.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>$defines_state_transform</li>\n                    <li>transformBy</li>\n                    <li>filterBy</li>\n                    <li>outputTo</li>\n                    <li>outputState</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>foreachStream()</code></td>\n            <td>Partitions the state for each of the streams provided.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>when</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>outputState()</code></td>\n            <td>If the projection maintains state, setting this option will produce a stream called $projections-{projection-name}-result with the state as the event body.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>transformBy</li>\n                    <li>filterBy</li>\n                    <li>outputTo</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>partitionBy(function(event))</code></td>\n            <td>Partitions a projection by the partition returned from the handler.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>when</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>transformBy(function(state))</code></td>\n            <td>Provides the ability to transform the state of a projection by the provided handler.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>transformBy</li>\n                    <li>filterBy</li>\n                    <li>outputState</li>\n                    <li>outputTo</li>\n                </ul>\n            </td>\n        </tr>\n        <tr>\n            <td><code>filterBy(function(state))</code></td>\n            <td>Causes projection results to be <code>null</code> for any <code>state</code> that returns a falsey value from the given predicate.</td>\n            <td>\n                <b>Provides</b>\n                <ul>\n                    <li>transformBy</li>\n                    <li>filterBy</li>\n                    <li>outputState</li>\n                    <li>outputTo</li>\n                </ul>\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n<h2 id=\"handlers\" sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"244\" sourceendlinenumber=\"244\">Handlers</h2>\n<p sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"246\" sourceendlinenumber=\"247\">Each handler is provided with the current state of the projection as well as the event that triggered the handler.\nThe event provided through the handler contains the following properties.</p>\n<ul sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"249\" sourceendlinenumber=\"256\">\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"249\" sourceendlinenumber=\"249\">isJson:true/false</li>\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"250\" sourceendlinenumber=\"250\">data:{}</li>\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"251\" sourceendlinenumber=\"251\">body:{}</li>\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"252\" sourceendlinenumber=\"252\">bodyRaw: string</li>\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"253\" sourceendlinenumber=\"253\">sequenceNumber: integer</li>\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"254\" sourceendlinenumber=\"254\">metadataRaw: {}</li>\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"255\" sourceendlinenumber=\"255\">linkMetadataRaw: string</li>\n<li sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"256\" sourceendlinenumber=\"256\">partition: string</li>\n</ul>\n<table>\n    <thead>\n        <tr>\n            <th>Handler</th>\n            <th>Description</th>\n            <th>Notes</th>\n        </tr>\n    </thead>\n    <tbody>\n         <tr>\n            <td><code>{event-type}</code></td>\n            <td>\n                When using fromAll() and 2 or more event type handlers are specified and the $by_event_type projection is enabled and running, the projection will start as a fromStreams(&#39;$et-event-type-foo&#39;, <code>$et-event-type-bar</code>) until the projection has caught up and then will move over to reading from the transaction log (i.e. from $all).\n            </td>\n            <td>\n            </td>\n        </tr>\n        <tr>\n            <td><code>$init</code></td>\n            <td>Provide the initialization for a projection.</td>\n            <td>\n                Commonly used to setup the initial state for a projection.\n            </td>\n        </tr>\n        <tr>\n            <td><code>$initShared</code></td>\n            <td>Provide the initialization for a projection where the projection is possibly partitioned.</td>\n            <td>\n            </td>\n        </tr>\n        <tr>\n            <td><code>$any</code></td>\n            <td>Event type pattern match that will match any event type.</td>\n            <td>\n                Commonly used when the user is interested in any event type from the selector.\n            </td>\n        </tr>\n        <tr>\n            <td><code>$deleted</code></td>\n            <td>Will be called upon the deletion of a stream.</td>\n            <td>\n                Can only be used with <code>foreachStream</code>\n            </td>\n        </tr>\n    </tbody>\n</table>\n\n<h2 id=\"functions\" sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"305\" sourceendlinenumber=\"305\">Functions</h2>\n<table>\n    <thead>\n        <tr>\n            <th>Name</th>\n            <th>Description</th>\n            <th>Notes</th>\n        </tr>\n    </thead>\n    <tbody>\n         <tr>\n            <td><code>emit(streamId, eventName, eventBody, metadata)</code></td>\n            <td>Writes an event to the designated stream</td>\n            <td>\n            </td>\n        </tr>\n        <tr>\n            <td><code>linkTo(streamId, event, metadata)</code></td>\n            <td>Writes a link to event to the designated stream</td>\n            <td>\n            </td>\n        </tr>\n    </tbody>\n</table>\n","type":"Conceptual","source":{"remote":{"path":"projections/user-defined-projections.md","branch":"swagger-docfx","repo":"git@github.com:EventStore/docs.geteventstore.com.git"},"startLine":0,"endLine":0,"isExternal":false},"path":"projections/user-defined-projections.md","documentation":{"remote":{"path":"projections/user-defined-projections.md","branch":"swagger-docfx","repo":"git@github.com:EventStore/docs.geteventstore.com.git"},"startLine":0,"endLine":0,"isExternal":false},"_docfxVersion":"2.31.0.0","_systemKeys":["conceptual","type","source","path","documentation","title","rawTitle","wordCount"],"title":"User Defined Projections","rawTitle":"<h1 id=\"user-defined-projections\" sourcefile=\"projections/user-defined-projections.md\" sourcestartlinenumber=\"1\" sourceendlinenumber=\"1\">User Defined Projections</h1>","wordCount":560,"_lang":"csharp","_tocPath":"docs/toc.html","_rel":"../../","_path":"docs/projections/user-defined-projections.html","_key":"projections/user-defined-projections.md","_tocRel":"../toc.html","_tocKey":"~/toc.md","__global":{"classesInSubtitle":"Classes","structsInSubtitle":"Structs","interfacesInSubtitle":"Interfaces","enumsInSubtitle":"Enums","delegatesInSubtitle":"Delegates","constructorsInSubtitle":"Constructors","fieldsInSubtitle":"Fields","propertiesInSubtitle":"Properties","methodsInSubtitle":"Methods","eventsInSubtitle":"Events","operatorsInSubtitle":"Operators","eiisInSubtitle":"Explicit Interface Implementations","functionsInSubtitle":"Functions","membersInSubtitle":"Members","improveThisDoc":"Improve this Doc","viewSource":"View Source","inheritance":"Inheritance","inheritedMembers":"Inherited Members","namespace":"Namespace","assembly":"Assembly","syntax":"Syntax","overrides":"Overrides","implements":"Implements","remarks":"Remarks","examples":"Examples","seealso":"See Also","declaration":"Declaration","parameters":"Parameters","typeParameters":"Type Parameters","type":"Type","name":"Name","description":"Description","returns":"Returns","fieldValue":"Field Value","propertyValue":"Property Value","eventType":"Event Type","exceptions":"Exceptions","condition":"Condition","extensionMethods":"Extension Methods","note":"<h5>Note</h5>","warning":"<h5>Warning</h5>","tip":"<h5>Tip</h5>","important":"<h5>Important</h5>","caution":"<h5>Caution</h5>","_shared":{}}}